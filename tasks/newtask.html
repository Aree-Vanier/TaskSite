<?php
$stmt = $conn->prepare("SELECT unassigned FROM tasks.tasks WHERE ID = ?");
$stmt->bind_param("i", $_GET["task"]);
$stmt->execute();
$task = $stmt->get_result()->fetch_assoc();

?>

<div class="popup" style="display:none">
    <div id="around" onclick="hideDiag()">
    </div>
    <div id="dialog">
        <h1>Create task</h1>
        <form action="create.php" method="post" target="_blank">
            <!--Changing these values won't bypass security, it will just make you post somewhere else (or not at all)-->
            <input type="hidden" name="mode" value="task"/>
            <input type="hidden" name="parent" value="<?php echo $_GET['task']?>"/>
            <input type="hidden" name="heads" value="<?php echo USER['name']?>"/>
            <label>Name <input type="text" name="name" placeholder="The task name"/></label>
            <label style="margin-left:0px; float:right; margin-right:-17%">Weight <input oninput="showValue(this)"
                                                                                         class="slider" type="range"
                                                                                         name="weight" value="<?php echo $task['unassigned']/5 ?>"
                                                                                         min="0"
                                                                                         max="<?php echo $task['unassigned'] ?>"/><input
                    oninput="showValue(this)" id="value" type="text" value="<?php echo $task['unassigned']/5 ?>" maxlength="3"/><span
                    class="unit">%</span></label>
            <br/>
            <br/>

            <span style="width:100%; text-align:center; display:block">Subteams</span>
            <div id="subteams">
                <select name='team1'>
                    <?php foreach(SUBTEAMS as $team){
                    echo "<option value='".$team["ID"]."'>".$team["name"]."</option>";
                    }?>
                </select>

                <select name='team2'>
                    <?php foreach(SUBTEAMS as $team){
                    echo "<option value='".$team["ID"]."'>".$team["name"]."</option>";
                    }?>
                </select>

                <select name='team3'>
                    <?php foreach(SUBTEAMS as $team){
                    echo "<option value='".$team["ID"]."'>".$team["name"]."</option>";
                    }?>
                </select>
            </div>
            <br/>
            <label>
                Description<br/>
                <textarea id="description" name="desc" rows="15" oninput="preview()"></textarea>
            </label>

            <div id="preview">


            </div>
            <button type="submit" onclick="location.reload()">Submit</button>
            <button type="button" onclick="hideDiag()">Cancel</button>
        </form>

    </div>

    <script>
        function showDiag() {
            document.getElementsByClassName("popup")[0].style.display = "block";
        }

        function hideDiag() {
            document.getElementsByClassName("popup")[0].style.display = "none";
        }

        function preview() {
            console.log("update");
            let val = document.getElementById("description").value.replace(/\n/g, "<br/>").replace(/<script/g, "&lt;script").replace(/<\/script/g, "&lt;/script");
            console.log(val);
            document.getElementById("preview").innerHTML = val;
        }

        function showValue(element) {
            if (element.nextElementSibling == null) {
                element.previousElementSibling.value = element.value;
            } else {
                element.nextElementSibling.value = element.value;
            }
        }
    </script>

</div>
